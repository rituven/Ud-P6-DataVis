<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <script src="http://d3js.org/d3.v3.min.js"></script>
            <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>

        <style>
        </style>
        <script type="text/javascript">
            function draw(data) {
                //debugger;
                
                var svg = dimple.newSvg("#chartContainer", 1300, 1400);
                
                //Filter out data for the Carrier we want to display
                data = dimple.filterData(data, "UniqueCarrier", ["WN", "AA", "OO", "B6",
                                                                 "MQ", "US", "DL", "UA",  "AS", "FL"
                                                           ]);
                                                           
                // Now filter for the Years
                                                           
                // Create the indicator chart on the left of the main chart
                var indicator = new dimple.chart(svg, data);
                                                           
                // Pick blue as the default and orange for the selected month
                var defaultColor = indicator.defaultColors[0];
                var indicatorColor = indicator.defaultColors[2];
                                                           
                // The frame duration for the animation in milliseconds
                var frame = 5000;
                var pauseState = false;
                var firstTick = true;
                                                           
                // Place the indicator bar chart to the left
                indicator.setBounds(75, 150, 50, 150);
                                                           
                // Add dates along the y axis
                var y = indicator.addCategoryAxis("y", "Year");
                y.addOrderRule("Year", true);
                                                           
                // add a measure for the bar size and hide the axis
                var x = indicator.addMeasureAxis("x", "TotalFlights");
                x.hidden = true;

                // Add the bars to the indicator and add event handlers
                var s = indicator.addSeries(null, dimple.plot.bar);
                s.addEventHandler("click", onClick);
                // Draw the side chart
                indicator.draw();

                // Remove the title from the y axis
                y.titleShape.remove();

                // Remove the lines from the y axis
                y.shapes.selectAll("line,path").remove();

                // Move the y axis text inside the plot area
                y.shapes.selectAll("text")
                .style("text-anchor", "start")
                .style("font-size", "11px")
                .attr("transform", "translate(18, 0.5)");

                // This block simply adds the legend title. I put it into a d3 data
                // object to split it onto 2 lines.  This technique works with any
                // number of lines, it isn't dimple specific.
                svg.selectAll("title_text")
                    .data(["Click bar to select",
                       "and pause. Click again",
                       "to resume animation"])
                    .enter()
                    .append("text")
                    .attr("x", 60)
                    .attr("y", function (d, i) { return 100 + i * 12; })
                    .style("font-family", "sans-serif")
                    .style("font-size", "10px")
                    .style("color", "Black")
                    .text(function (d) { return d; });
       
                // Manually set the bar colors
                s.shapes
                    .attr("rx", 10)
                    .attr("ry", 10)
                    .style("fill", function (d) { return (d.y === '2000' ?
                                                          indicatorColor.fill : defaultColor.fill) })
                    .style("stroke", function (d) { return (d.y === '2000' ?
                                                            indicatorColor.stroke : defaultColor.stroke) })
                    .style("opacity", 0.4);
                    
                //Now draw the chart for Air Carrier performance by Month
       
                var myChart = new dimple.chart(svg, data);
                myChart.setBounds(300, 50, 480, 330);
                svg.append("text")
                .attr("x", myChart._xPixels() + myChart._widthPixels() / 2)
                .attr("y", myChart._yPixels() - 20)
                .style("text-anchor", "middle")
                .style("font-family", "sans-serif")
                .style("font-weight", "bold")
                .text("Percentage Time On Ground for Aircrafts by Airline");
                yaxis = myChart.addCategoryAxis("y", "PctTimeOnGround");
                xaxis = myChart.addCategoryAxis("x", "Month");
                yaxis.title = "Percentage Time On Ground"
                xaxis.title = "Month"
                //y.addOrderRule("Date");
                //myChart.addCategoryAxis("z", "TotalFlights");
                myChart.addMeasureAxis("z", "TotalFlights");
                var myPlot = myChart.addSeries(["Year", "TotalDistance", "CarrierName"], dimple.plot.bubble);
                //myLegend.verticalPadding = 10;
                var myLegend = myChart.addLegend(900, 70, 100, 200, "Right");
                myChart.draw();
                
                // This is a critical step.  By doing this we orphan the legend. This
                // means it will not respond to graph updates.  Without this the legend
                // will redraw when the chart refreshes removing the unchecked item and
                // also dropping the events we define below.
                
                myChart.legends = [];
                
                // This block simply adds the legend title. I put it into a d3 data
                // object to split it onto 2 lines.  This technique works with any
                // number of lines, it isn't dimple specific.
                svg.selectAll("title_text")
                    .data(["Click legend to","show/hide carriers:"])
                    .enter()
                    .append("text")
                    .attr("x", 850)
                    .attr("y", function (d, i) { return 50 + i * 14; })
                    .style("font-family", "sans-serif")
                    .style("font-size", "10px")
                    .style("color", "Black")
                    .text(function (d) { return d; });
                
                // Get a unique list of Owner values to use when filtering
                var filterValues = dimple.getUniqueValues(data, "CarrierName");
                // Get all the rectangles from our now orphaned legend
                myLegend.shapes.selectAll("rect")
                // Add a click event to each rectangle
                .on("click", function (e) {
                    // This indicates whether the item is already visible or not
                    var hide = false;
                    var newFilters = [];
                    // If the filters contain the clicked shape hide it
                    filterValues.forEach(function (f) {
                                         if (f === e.aggField.slice(-1)[0]) {
                                            hide = true;
                                         } else {
                                            newFilters.push(f);
                                         }
                    });
                    // Hide the shape or show it
                    if (hide) {
                        d3.select(this).style("opacity", 0.2);
                    } else {
                        newFilters.push(e.aggField.slice(-1)[0]);
                        d3.select(this).style("opacity", 0.8);
                    }
                    // Update the filters
                    filterValues = newFilters;
                    // Filter the data
                    myChart.data = dimple.filterData(data, "CarrierName", filterValues);
                    // Passing a duration parameter makes the chart animate. Without
                    // it there is no transition
                    myChart.draw(800);
                    if (pauseState === true) {
                    story.pauseAnimation()
                    }

                
                });
                // Add a storyboard to the main chart and set the tick event
                var story = myChart.setStoryboard("Year", onTick);
                // Change the frame duration
                story.frameDuration = frame;
                // Order the storyboard by date
                story.addOrderRule("Year");
                // Draw the line chart
                myChart.draw();
                // Orphan the legends as they are consistent but by default they
                // will refresh on tick and we don't want the legend text to change
                // with the data changes
                myChart.legends = [];
                // Remove the storyboard label because the chart will indicate the
                // current year instead of the label
                story.storyLabel.remove();
                // On click of the side chart
                function onClick(e) {
                    // Pause the animation
                    pauseState = true;
                    story.pauseAnimation();
                    // If it is already selected resume the animation
                    // otherwise pause and move to the selected Year
                    if (e.yValue === story.getFrameValue()) {
                        pauseState = false;
                        story.startAnimation();
                    } else {
                        pauseState = true;
                        story.goToFrame(e.yValue);
                        story.pauseAnimation();
                    }
                }
                // On tick of the main charts storyboard
                function onTick(e) {
                    if (!firstTick) {
                        // Color all shapes the same
                        s.shapes
                        .transition()
                        .duration(frame / 2)
                        .style("fill", function (d) {
                               return (d.y === e ?
                                       indicatorColor.fill : defaultColor.fill)
                               })
                               .style("stroke", function (d) {
                                      return (d.y === e ?
                                              indicatorColor.stroke : defaultColor.stroke)
                                      });
                    }
                    firstTick = false;
                }
                function onHover(e) {
                    dimple._showPointTooltip(e, this, lines, avg);
                    lines.draw();
                    story.pauseAnimation();
                };
                function onLeave(e) {
                    if (pauseState === false) {
                        story.startAnimation();
                    } else {
                        lines.draw();
                        story.pauseAnimation();
                    }
                };



            };
        </script>
    </head>
    <body>
        <div id="chartContainer">
        <script type="text/javascript">
            /*
             Use D3 (not dimple.js) to load the CSV file
             and pass the contents of it to the draw function
             */
        d3.csv("AircraftSummary.csv", draw);
            </script>
        </div>
    </body>
</html>
